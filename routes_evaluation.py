#TODO Criteria to evaluate the routes generated by the genetic algorithm executions, basead on indepentent variables from fitness function
from delivery_setup.deliveries import load_deliveries_info as ldi
from delivery_setup.vehicles import load_vehicles_info as lvi

class RouteEvaluator:
    def __init__(self, city: str, routes_metadata: dict[int, list[tuple[str, str]]]):
        self.routes_metadata = routes_metadata
        self.vehicle_data = lvi(city)
        self.delivery_data = ldi(city)

    def capacity_utilization(self) -> dict[int, float]:
        utilization = {}
        for route_id, deliveries in self.routes_metadata.items():
            vehicle_id = deliveries[0][1]  # Assuming all deliveries in the route use the same vehicle
            vehicle_capacity = self.vehicle_data[vehicle_id]["capacity"]
            total_demand = sum(self.delivery_data[int(delivery[0])]["demand"] for delivery in deliveries)
            utilization[route_id] = total_demand / vehicle_capacity if vehicle_capacity > 0 else 0.0
        return utilization
    
    def travel_costs(self) -> dict[int, float]:
        costs = {}
        for route_id, deliveries in self.routes_metadata.items():
            vehicle_id = deliveries[0][1]  # Assuming all deliveries in the route use the same vehicle
            vehicle_cost_per_M = self.vehicle_data[vehicle_id]["cost_M"]
            total_distance_M = len(deliveries) * 0.01  # Example: each delivery adds 0.01 Manhattan units
            costs[route_id] = total_distance_M * vehicle_cost_per_M
        return costs
    
    def critical_delivery_count_by_deliveries(self) -> dict[int, int]:
        critical_counts = {}
        for route_id, deliveries in self.routes_metadata.items():
            critical_count = sum(1 for delivery in deliveries if self.delivery_data[int(delivery[0])]["priority"] > 2)
            critical_counts[route_id] = critical_count
        return critical_counts
    
if __name__ == "__main__":
    from genetic_algorithm import GeneticAlgorithm
    city_code = "SP"

    ga = GeneticAlgorithm(
        city_code=city_code,
        population_length=100,
        max_generations=5000,
        ratio_elitism=0.1,
        ratio_mutation=0.5,
        tournament_k=5
    )

    routes_metadata = ga.run()
    evaluator = RouteEvaluator(city=city_code, routes_metadata=routes_metadata)
    capacity_util = evaluator.capacity_utilization()
    travel_costs = evaluator.travel_costs()
    critical_counts = evaluator.critical_delivery_count_by_deliveries()

    print("Capacity Utilization by Route:", capacity_util)
    print("Travel Costs by Route:", travel_costs)
    print("Critical Delivery Counts by Route:", critical_counts)
